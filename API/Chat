local Assets = require "Assets"
local Screen = require "API/Buffer" 
local Player = require "API/Player"

local colorCodes = {["0"] = colors.black, ["1"] = colors.blue, ["2"] = colors.green, ["3"] = colors.cyan, ["4"] = colors.red, ["5"] = colors.purple, ["6"] = colors.orange, ["7"] = colors.lightGray, ["8"] = colors.gray, ["9"] = colors.magenta, a = colors.lime, b = colors.lightBlue, c = colors.brown, d = colors.pink, e = colors.yellow, f = colors.white}
local convertToColorCode = {[colors.black] = 0, [colors.blue] = 1, [colors.green] = 2, [colors.cyan] = 3, [colors.red] = 4, [colors.purple] = 5, [colors.orange] = 6, [colors.lightGray] = 7, [colors.gray] = 8, [colors.magenta] = 9, [colors.lime] = "a", [colors.lightBlue] = "b", [colors.brown] = "c", [colors.pink] = "d", [colors.yellow] = "e", [colors.white] = "f"}
local gmatch, sub, find, lower = string.gmatch, string.sub, string.find, string.lower
local ScreenWidth, ScreenHeight = Screen.getSize()
local chatHistory = {}

-- Optimize me!!!
local function addMessage(message, private) 
    local msg, lineX, lineLimit = {}, 1, math.ceil(ScreenWidth / 2)
    for output in string.gmatch(message, "([^%s]+)") do msg[#msg + 1] = output end
    for i = 1, #msg do if i ~= #msg then msg[i] = msg[i].. " " end end
    local outputMessage, currentLine = {}, 1
    for i = 1, #msg do
        if lineX + #msg[i] <= lineLimit then
            lineX = lineX + #msg[i]
            outputMessage[currentLine] = (outputMessage[currentLine] or "").. "" ..msg[i]
            --elseif lineX + #msg[i] <= lineLimit + 1 then
            --  lineX = lineX + #msg[i]
            --  outputMessage[currentLine] = (outputMessage[currentLine] or "").. "" ..string.sub(msg[i], 1, #msg[i] - 1)
        else
            lineX, currentLine = 0, currentLine + 1

             -- fix this part for the long strings
            if lineX + #msg[i] <= lineLimit then
                lineX = lineX + #msg[i]
                outputMessage[currentLine] = (outputMessage[currentLine] or "").. "" ..msg[i]
            else
                outputMessage[currentLine] = msg[i - 1].. " " ..string.sub(msg[i], 1, lineLimit - #msg[i - 1] - 1)
                for i = 2, math.ceil(#msg[i] / math.floor(lineLimit)) do 
                    currentLine = currentLine + 1
                    outputMessage[currentLine] = string.sub(msg[i], lineLimit * 2, lineLimit * 3)
                end
            end 
        end
    end
    for i = 1, #outputMessage do chatHistory[#chatHistory + 1] = {outputMessage[i], private or false} end
end

local chatFunctions = {
    ["/give"] = function(args, playerName)
    end,

    ["/gamemode"] = function(args, playerName)
    end,

    ["/whisper"] = function(args, playerName)
    end,

    ["/tp"] = function(args, playerName)
    end,

    ["/warp"] = function(args, playerName)
    end,

    ["/say"] = function(args, playerName)
    end,

    ["/save"] = function(args, playerName)
    end,

    ["/spawn"] = function(args, playerName)
    end,

    ["/setspawn"] = function(args, playerName)
    end,

    ["/time"] = function(args, playerName)
    end,

    ["/heal"] = function(args, playerName)
    end,

    ["/kill"] = function(args, playerName)
    end,

    ["/run"] = function(args, playerName)
    end,

    ["/help"] = function(args, playerName)
    end,

    -- Server related commands
    ["/kick"] = function(args, playerName)

    end,

    ["/ban"] = function(args, playerName)

    end,

    ["/unban"] = function(args, playerName)

    end,

    ["/op"] = function(args, playerName)

    end,

    ["/stop"] = function(args, playerName)

    end,

    ["/restart"] = function(args, playerName)

    end,

    ["/seed"] = function(args, playerName)
    end
}

chatFunctions["/i"] = chatFunctions["/give"]
chatFunctions["/gm"] = chatFunctions["/gamemode"]
chatFunctions["/w"] = chatFunctions["/whisper"]

local msg, args = {}, {}
return {
    convertToColorCode = function(color)         return convertToColorCode[color] and "&" ..convertToColorCode[color] end,
    getColor           = function(code)          return colorCodes[code]                                              end,
    getMessages        = function()              return chatHistory                                                   end,
    setMessages        = function(newMessages)   chatHistory = newMessages or chatHistory                             end,
    addCommand         = function(cmdName, func) chatFunctions[cmdName] = func                                        end,

    -- Just add in the color to the background. Directly modify the buffer.
    writeInColor = function(message, x, y)
        if x and y then Screen.setCursorPos(x, y) end
        if not find(message, "&") then Screen.write(message); return end

        msg = {}; for s in gmatch(message, "([^%s]+)") do msg[#msg + 1] = s end
        for i = 1, #msg do
            local tString = msg[i]
          
            for x = 1, #tString do
                if sub(tString, x, x) == "&" then
                    local code = lower(sub(tString, x + 1, x + 1))
                    if colorCodes[code] then Screen.setTextColor(colorCodes[code]) 
                    --if msg[i + 1] then msg[i + 1] = "&" ..code.. "" ..msg[i + 1] end
                    tString = sub(tString, 1, x - 1).. "" ..sub(tString, x + 1); x = x - 1
                    else Screen.write(sub(tString, x, x)) end
                else Screen.write(sub(tString, x, x)) end
            end
            if i ~= #msg then Screen.write(" ") end
        end
    end,

    sendMessage = function(message, playerName)
        if type(message) == "string" and message ~= "" then 
            if sub(message, 1, 1) == "/" then
                args = {}; for s in gmatch(message, "([^%s]+)") do args[#args + 1] = s end
                local result = chatFunctions[args[1]] and chatFunctions[args[1]](args, Player.player(playerName)) or addMessage("&7No such command"); args = nil
            else addMessage(playerName and "&f<" ..playerName.. "&f> " ..message or message) end
        end
    end
}